---
import * as cheerio from 'cheerio';

interface Props {
  content: string;
}

const { content } = Astro.props;
const $ = cheerio.load(content);

$('img').each((_, el) => {
  const imageEl = $(el);
  const src = imageEl.attr('src');

  if (src && (src.includes('bp.blogspot.com') || src.includes('googleusercontent.com'))) {
    imageEl.addClass('blogger-image-to-optimize');
  }

  if (!imageEl.attr('alt')) {
    imageEl.attr('alt', 'Gambar artikel');
  }
  imageEl.attr('loading', 'lazy');
});


const siteUrl = Astro.site ? Astro.site.origin : '';

$('a[href^="http"]').each((_, el) => {
  const linkEl = $(el);
  const href = linkEl.attr('href') || '';
  if (siteUrl && !href.startsWith(siteUrl)) {
    linkEl.attr('rel', 'noopener noreferrer nofollow');
    linkEl.attr('target', 'blank');
  }
});

$('table').each((_, el) => {
  const tableEl = $(el);
  if (!tableEl.parent().hasClass('responsive-table-wrapper')) {
    tableEl.wrap('<div class="responsive-table-wrapper" style="overflow-x: auto;"></div>');
  }
  if (!tableEl.find('caption').length) {
    tableEl.prepend('<caption>Tabel data</caption>');
  }
  tableEl.addClass('table-auto w-full border border-gray-700 text-sm');
});

$('th, td').addClass('border px-3 py-2');
$('svg:not(:has(title))').prepend('<title>Ikon</title>');
$('h1,h2,h3,h4,h5,h6').filter((_, el) => !$(el).text().trim()).text('Tanpa Judul');
$('a').filter((_, el) => !$(el).text().trim()).attr('aria-label', 'Tautan tanpa teks');
$('ul, ol').filter((_, el) => !$(el).children('li').length).append('<li>Item kosong</li>');
$('script, style, link[rel="stylesheet"]').remove();

const sanitizedHtml = $.html();
---

<div class="prose max-w-full prose-sm sm:prose-base">
  <Fragment set:html={sanitizedHtml} />
</div>

<script>
  function optimizeBloggerImages() {
    const images = document.querySelectorAll('.blogger-image-to-optimize');

    images.forEach(img => {
      const currentSrc = img.getAttribute('src');
      if (currentSrc) {
        const baseUrl = currentSrc.split(/\/(s\d+|w\d+-h\d+)/)[0];
        const newSrc = `${baseUrl}/s1200-rw`;
        img.setAttribute('src', newSrc);
        img.classList.remove('blogger-image-to-optimize');
      }
    });
  }
  document.addEventListener('DOMContentLoaded', optimizeBloggerImages);
</script>