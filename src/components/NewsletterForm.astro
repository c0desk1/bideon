---
const siteKey = import.meta.env.VITE_PUBLIC_TURNSTILE_SITE_KEY;

const turnstile = `
  window.onTurnstileSuccess = function (token) {
    const form = document.getElementById("newsletter-form");
    const emailInput = form.querySelector('input[name="email"]');
    const email = emailInput?.value || "";

    if (!email || !token) {
      alert("Email atau token kosong.");
      return;
    }

    fetch("/api/newsletter-submit", {
      method: "POST",
      body: new URLSearchParams({
        email: email,
        "cf-turnstile-response": token
      })
    })
    .then(res => {
      if (res.ok) {
        alert("Langganan berhasil!");
        form.reset();
      } else {
        res.text().then(text => alert("Gagal: " + text));
      }
    })
    .catch(() => alert("Gagal mengirim form."));
  };

  window.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("newsletter-form");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (typeof window.turnstile !== "undefined") {
          window.turnstile.execute();
        }
      });
    }
  });
`;

---

<section class="max-w-2xl mx-auto px-4 py-16 text-center">
  <h2 class="text-3xl font-semibold tracking-tight text-[var(--color-text)]">Tetap Terhubung</h2>
  <p class="mt-3 text-base text-[var(--color-text-muted)]">
    Langganan kabar terbaru. Tidak ada spam, cukup kualitas.
  </p>

  <form
    id="newsletter-form"
    class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-2"
  >
    <input
      type="email"
      name="email"
      placeholder="email@example.com"
      required
      class="w-full sm:w-auto sm:flex-grow rounded-md border border-[var(--color-border)] bg-[var(--color-bg)] px-4 py-2 text-sm text-[var(--color-text)] placeholder:text-[var(--color-text-muted)] focus:border-[var(--color-accent)] focus:outline-none focus:ring-1 focus:ring-[var(--color-accent)]"
    />
    <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-token" />
    <button
      type="submit"
      class="rounded-md bg-[var(--color-accent)] px-5 py-2 text-sm font-medium text-white transition hover:bg-[var(--color-accent-dark)]"
    >
      Langganan
    </button>
  </form>

  <div class="sr-only">
    <div
      class="cf-turnstile"
      data-sitekey={typeof siteKey === "string" ? siteKey : ""}
      data-size="invisible"
      data-theme="auto"
      data-callback="onTurnstileSuccess"
    ></div>
  </div>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script is:inline set:html={turnstile}></script>

  <p class="mt-6 text-xs text-[var(--color-text-muted)]">
    Kami tidak jual datamu. Bisa berhenti kapan saja.
  </p>
</section>
