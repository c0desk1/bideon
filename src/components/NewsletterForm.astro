---
const siteKey = import.meta.env.VITE_PUBLIC_TURNSTILE_SITE_KEY;

const turnstile = `
  window.onTurnstileReady = function (token) {
    const input = document.getElementById("cf-turnstile-token");
    const form = document.getElementById("newsletter-form");

    if (input && form && "value" in input && typeof form.submit === "function") {
      input.value = token;
      form.submit();
    }
  };

  window.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("newsletter-form");
    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (typeof window.turnstile !== "undefined") {
          window.turnstile.execute();
        }
      });
    }
  });
`;
---

<section class="max-w-2xl mx-auto px-4 py-16 text-center">
  <h2 class="text-3xl font-semibold tracking-tight text-[var(--color-text)]">Tetap Terhubung</h2>
  <p class="mt-3 text-base text-[var(--color-text-muted)]">Langganan kabar terbaru. Tidak ada spam, cukup kualitas.</p>

  <form
    id="newsletter-form"
    method="POST"
    action="/api/newsletter-submit"
    class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-2"
  >
    <input
      type="email"
      name="email"
      placeholder="email@example.com"
      required
      autocomplete="email"
      class="w-full sm:w-auto sm:flex-grow rounded-md border border-[var(--color-border)] bg-[var(--color-bg)] px-4 py-2 text-sm text-[var(--color-text)] placeholder:text-[var(--color-text-muted)] focus:border-[var(--color-accent)] focus:outline-none focus:ring-1 focus:ring-[var(--color-accent)]"
    />
    <input type="hidden" name="cf-turnstile-response" id="cf-turnstile-token" />
    <button
      type="submit"
      class="rounded-md bg-[var(--color-accent)] px-5 py-2 text-sm font-medium text-white transition hover:bg-[var(--color-accent-dark)]"
    >
      Langganan
    </button>
  </form>

  <div class="sr-only">
   {siteKey && typeof siteKey === "string" ? (
      <div
        class="cf-turnstile"
        data-sitekey={siteKey}
        data-size="invisible"
        data-theme="auto"
        data-callback="onTurnstileReady"
      ></div>
    ) : (
      <p class="text-red-500 text-sm mt-4">Turnstile belum dikonfigurasi.</p>
    )}
  </div>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script is:inline set:html={turnstile}></script>
  <p class="mt-6 text-xs text-[var(--color-text-muted)]">Kami tidak jual datamu. Bisa berhenti kapan saja.</p>
</section>
